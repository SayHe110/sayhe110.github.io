<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="LeiJian"><title>Gin 中模型验证 validator.v9 · LeiJian</title><meta name="description" content="Gin 默认的模型验证为 validator 库，并且提供了多个版本供我们使用，如 v8，v9，我自己在使用的时候我会默认使用 v9 这个版本，因为在写自定义验证函数时更方便简洁。
v8 版本的自定义验证123456789101112func ValidateUserNameUniq(	v *val"><meta name="keywords"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"></head><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?7706e2ba8c658f563720bb36e8a87962";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();</script><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo@2x.png" style="width:127px;"><h3 title><a href="/">LeiJian<p>PHP Engineer</p></a></h3></div></div><ul class="social-links"><li><a href="http://github.com/sayhe110"><i class="fa fa-github"></i></a></li></ul><div class="footer"><a target="_blank" href="/"><span>Theme by </span></a><a href="https://www.caicai.me"> CaiCai </a><span>&</span><a href="https://github.com/Ben02/hexo-theme-Anatole"> Ben</a><div class="by_farbox"><a href="https://hexo.io/zh-cn/" target="_blank">Proudly published with Hexo&#65281;</a></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">首页</a></li><li><a href="/about">关于我</a></li><li><a href="/archives">归档</a></li><li><a href="/links">链接</a></li><li><a href="/reading">阅读</a></li></div><div class="information"><div class="back_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li></div><div class="avatar"><img src="/images/favicon.png"></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>Gin 中模型验证 validator.v9</a></h3></div><div class="post-content"><p>Gin 默认的模型验证为 validator 库，并且提供了多个版本供我们使用，如 v8，v9，我自己在使用的时候我会默认使用 v9 这个版本，因为在写自定义验证函数时更方便简洁。</p>
<h4 id="v8-版本的自定义验证"><a href="#v8-版本的自定义验证" class="headerlink" title="v8 版本的自定义验证"></a>v8 版本的自定义验证</h4><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ValidateUserNameUniq</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">	v *validator.Validate, topStruct reflect.Value, currentStructOrField reflect.Value,</span></span></span><br><span class="line"><span class="function"><span class="params">	field reflect.Value, fieldType reflect.Type, fieldKind reflect.Kind, param <span class="keyword">string</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">	<span class="comment">// 数据库唯一性验证</span></span><br><span class="line">	<span class="keyword">var</span> count <span class="keyword">int</span></span><br><span class="line">	user := model.User&#123;&#125;</span><br><span class="line">	_ = model.DB.Self.Where(<span class="string">"name = ?"</span>, field.String()).Find(&amp;user).Count(&amp;count)</span><br><span class="line"></span><br><span class="line">	res := count &gt; <span class="number">0</span></span><br><span class="line">	<span class="keyword">return</span> !res</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，我只想简单的验证下字段值是否唯一，但是这有着一堆的反射参数，看着就头疼</p>
<h4 id="v9-版本的自定义验证"><a href="#v9-版本的自定义验证" class="headerlink" title="v9 版本的自定义验证"></a>v9 版本的自定义验证</h4><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">FiledValUnique</span><span class="params">(fl validator.FieldLevel)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> (</span><br><span class="line">        conn  = db.NewMysql(config.C)</span><br><span class="line">        count = <span class="number">0</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    value := fl.Field().String()</span><br><span class="line">    column := strings.ToLower(fl.FieldName())</span><br><span class="line"></span><br><span class="line">    conn.Table(tableNameVar).Where(column+<span class="string">"= ? "</span>, value).Count(&amp;count)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ! (count &gt; <span class="number">0</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我自己封装了一个 v9 版本的自定义验证函数，这就非常的简单了，用到什么就取什么，我这里用到了要判断的值，及要判断的哪一列。</p>
<h4 id="Demo"><a href="#Demo" class="headerlink" title="Demo"></a>Demo</h4><div class="tip">
    下面的代码中 config.C.Uni 为 "github.com/go-playground/universal-translator" 中的 ut.New() 实例<br>
    config.C 为 配置的实例
</div>

<h5 id="Model"><a href="#Model" class="headerlink" title="Model"></a>Model</h5><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> model</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    validatorPkg <span class="string">"learnku-api/pkg/validator"</span></span><br><span class="line">    <span class="string">"time"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> CategoryParams <span class="keyword">struct</span> &#123;</span><br><span class="line">    Name        <span class="keyword">string</span> <span class="string">`form:"name" binding:"required" validate:"max=25,min=10,filed_unique"`</span></span><br><span class="line">    Description <span class="keyword">string</span> <span class="string">`form:"description" binding:"required"`</span></span><br><span class="line">    CreatedAt   <span class="keyword">int64</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(params *CategoryParams)</span> <span class="title">CategoryStoreValidator</span><span class="params">()</span> <span class="params">(valError validatorPkg.CommonError)</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> validatorPkg.CustomValParams(params, validatorPkg.FiledValUnique, <span class="string">"filed_unique"</span>, <span class="string">"categories"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="validator"><a href="#validator" class="headerlink" title="validator"></a>validator</h5><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> validator</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"gopkg.in/go-playground/validator.v9"</span></span><br><span class="line">    <span class="string">"learnku-api/config"</span></span><br><span class="line">    <span class="string">"learnku-api/pkg/db"</span></span><br><span class="line">    <span class="string">"strings"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 无法获取表名，所以直接传表名即可</span></span><br><span class="line"><span class="keyword">var</span> tableNameVar <span class="keyword">string</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">CustomValParams</span><span class="params">(params <span class="keyword">interface</span>&#123;&#125;, customFunc validator.Func, tagName, tableName <span class="keyword">string</span>)</span> <span class="params">(valError CommonError)</span></span> &#123;</span><br><span class="line">    tableNameVar = tableName</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 输出错误结果为中文</span></span><br><span class="line">    trans, _ := config.C.Uni.GetTranslator(<span class="string">"zh"</span>)</span><br><span class="line">    _ = config.C.Validate.RegisterValidation(tagName, customFunc)</span><br><span class="line"></span><br><span class="line">    err := config.C.Validate.Struct(params)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> GetValidatorError(err, trans)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">FiledValUnique</span><span class="params">(fl validator.FieldLevel)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> (</span><br><span class="line">        conn  = db.NewMysql(config.C)</span><br><span class="line">        count = <span class="number">0</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    value := fl.Field().String()</span><br><span class="line">    column := strings.ToLower(fl.FieldName())</span><br><span class="line"></span><br><span class="line">    conn.Table(tableNameVar).Where(column+<span class="string">"= ? "</span>, value).Count(&amp;count)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ! (count &gt; <span class="number">0</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="validator-1"><a href="#validator-1" class="headerlink" title="validator"></a>validator</h5><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> validator</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"github.com/go-playground/universal-translator"</span></span><br><span class="line">    <span class="string">"gopkg.in/go-playground/validator.v9"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> CommonError <span class="keyword">struct</span> &#123;</span><br><span class="line">    Errors <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 返回错误信息</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetValidatorError</span><span class="params">(err error, trans ut.Translator)</span> <span class="params">(res CommonError)</span></span> &#123;</span><br><span class="line">    res = CommonError&#123;&#125;</span><br><span class="line">    res.Errors = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>&#123;&#125;)</span><br><span class="line">    errs := err.(validator.ValidationErrors)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> _, e := <span class="keyword">range</span> errs &#123;</span><br><span class="line">        res.Errors[e.Field()] = e.Translate(trans)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>在运行时，发现 FiledValUnique() 函数运行了两次。。。。</p>
</blockquote>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2019-10-09</span><i class="fa fa-tag"></i></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank"></a></div><div class="weibo"><a class="fa fa-weibo" href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));"></a></div><div class="twitter"><a class="fa fa-twitter" href="http://twitter.com/home?status=,http://blog.sayhe110.cn/2019/10/09/Gin-中模型验证-validator-v9/,LeiJian,Gin 中模型验证 validator.v9,;"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/2019/12/10/遇到-DDOS/" title="遇到 DDOS">Post Anterior</a></li><li class="next pagbuttons"><a class="btn" role="navigation" href="/2019/07/31/MySQL运行原理【数据页】/" title="MySQL运行原理【数据页】">Próximo post</a></li></ul></div></div></div></div></div><script src="/js/jquery.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script></body></html>